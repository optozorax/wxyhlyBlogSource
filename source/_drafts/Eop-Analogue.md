---
title: 给自己量身打造一个电脑钢琴
tags:
- javascript
- 音乐
---
　　怎么用电脑键盘来弹钢琴？其实这种电脑钢琴软件很多，比如我之前接触过Every one piano，比较出名的还有Freepiano。当然我们也可以自己做一个类似的东西。
#### [这里是成品，点开即玩](/Eop/)
使用方法可以在点开后的菜单条的“?”查看，本文也有一部分说明，但侧重记录我对它的想法与实现过程。
## 开始的想法
我开始这个想法是看到了一个叫Midi.js的库，它使用了html5的新标准Web audio来播放音频片段，其初衷是为了让midi文件在浏览器html5 audio上直接播放出来。midi文件不同于一般的mp3、wav文件，它不是记录声音的波形，而是记录音符的音高、时值等信息来播放音乐，所以它的文件较小，是非智能手机时代铃声常用的格式。
　　用MIDI.js很容易就能自己写出一个键盘钢琴程序（会点基础javascript就行，就是直接添加键盘事件来播放指定的声音文件）我叫它EOP类似物，而且演奏音符几乎无延迟！我以前用Flash也做过电脑钢琴，但延迟太大。（按下一个键要等将近半秒才发声）在Safari及不同版本Chrome下都能发声，但Edge浏览器好像一直没声音。这主要取决于浏览器对Web audio的支持情况。
　　本着什么轮子都自己造，锁尔乱七八糟的库的原则，我自己去下载了音色，抛弃MIDI.js，自己写了一个键盘钢琴程序。而且我发现后来MIDI.js这个项目不再更新了，取而代之的是一个叫tone.js的库，这个库更加强大：它可以支持一些简单的合成器与效果器！感觉浏览器都有往编曲软件发展的潜力了。但我还是没有用tone.js，只是借鉴了它的部分源码，比如通过在小范围内调整播放速度改变音高可以减少加载2倍的音色音乐片段！这对提高音色下载速度有重大意义。
## 电脑键盘如何弹钢琴
　　问题是，电脑键盘与钢琴键盘不一样，怎么布局才最合理？我看到过用电脑键盘上ABCDEFG直接对应do re mi fa sol sa si的，这种布局导致原音阶顺序完全打乱，不可取，一般才用这种键盘的游戏跟练打字没啥区别。
![这简直是对钢琴的侮辱！我打死也不会用这种键盘！](/img/eopplt001.jpg)
而Every one piano采用的是这样的布局：
![Every one piano默认键盘布局](/img/eopplt001.png)
这种布局才是正确的音阶思维方式，但它都还有缺点：无法弹奏半音阶。电脑键盘没有真正的钢琴键盘那么长，如果我们交替在键盘上像钢琴那样安排黑键的位置，虽然这种布局是最接近真实钢琴的，但你几乎别指望用它左右手演奏完整乐曲，因为键位不够，音域会非常狭窄。但有半音（调外音）的曲子很多，为此Every one piano支持设置每个键对应什么音，你可以根据曲子自己把需要的半音安排上去。这种方法在演奏中效果是非常好的，而且通过设置每个键盘的声部，还可以做到伴奏与旋律拥有不同力度，可以说已经挖掘到到电脑键盘的极限潜力了。
但我还是不满意。
## 即兴自由演奏
　　最先我的EOP类似物只是弹奏、记录弹奏音符、回放这些功能。后来我发现它可以辅助作曲、编曲。说实话，我的演奏技术并不好，所以我从来不追求什么演奏效果，但我的兴趣在于作曲、编曲。我需要更加灵活的输入半音的方式（哪怕不太方便快速输入）所以我决定不在我的EOP类似物里面加入每个键位的修改设置，取而代之，通过很多方法来设置调号的升降记号和临时变音记号。我琢磨了很多方案，升降调输入方式的演变是这样的：
- 首先Eop有移调功能，这样就不用弹很多半音（黑键）。但这个只适合真的变调，不适合临时变音记号。
- 最原始的想法是通过按住空格键的方式来使所有的音升高半音，这样就解决了所有音都能够在一个键盘上弹出来了。之所以选空格键是因为它长，方便按。
- 然而当你弹和弦的时候很致命，比如同时弹2 #4 6，按住空格键所有音都回升高。因此我给方向键引入了#1、#4、#5、#6来解决这个问题：按下一次后即升对应的音，除非按shift键才能还原清除。所以遇到小调里的#5就不用怕了。按方向键#5后就可以弹了，但需要注意的是要弹还原sol之前一定要按shift还原。
- 由于存在要按shift还原的问题还是不太好用。我又想到了一个奇招：如果同时弹的音只有一个音要升半音，那我还不如稍微提前一点点弹下它来跟其他因区分。我决定还是用空格键实现这个功能：如果你按住空格键不弹没弹其他音就松开了，系统回等待你弹下一个音把它升高。这样通过微妙控制时间差可以摆脱方向键跟shift键的束缚。
- 后来我发现我的键盘还有瑕疵：没有#2(♭3)。我又规定了：按住shift+方向键可以临时变♭2、♭3、♭5、♭6。后来发现每次按shift也不方便，干脆加了一个升/降快捷键Ctrl+~来交替升/降操作的地位：比如切换到降调模式后按空格键回吧所有音降半音而不是默认的升，且方向键直接能临时降四个音，按住shift反而是临时升。
- 我也不是只即兴，有时也会去找五线谱弹。虽然可以用移调来弹任何谱子，但这种方法总是很笨拙，也不利于培养绝对音感。我于是又设计了Alt+数字的快捷键设置调号：数字代表#的个数（比如A大调#1 #4 #5就按Alt+3）。如果是♭记号，则用Alt+~+数字（比如♭A大调♭2 ♭3 ♭6 ♭7就按Alt+~+4）。调号设置在于按shift不会将它清除（清除调号单独用Alt+Q），这样可以放心用方向键临时变音了。

　　虽然这样做还是不能完全跟midi键盘比，（比如半音阶上行、下行旋律演奏困难、键盘按键冲突）但体验确实好得多。这写操作其实是根据我自己的喜好定制的，现在让我用Everyone piano那种固定键位的来即兴反而不如我的EOP类似物顺手。
　　其实这里面可做的东西还很多。比如我之前尝试过用计算机来作曲（根本不会神经网络那些，直接在音阶内一定范围内Math.random()），电脑键盘模拟吉他可以按弦、扫弦（键位冲突太厉害，基本没法用）等，但比较失败。然后也加入了Freepiano那种踩鼠标当踏板的功能。（点击踏板按钮再点击锁尔后放到地上踩，以免脚移动误操作）

## 变成midi编辑器
　　在没有MIDI键盘的情况下编曲必须靠鼠标一个一个画音符，速度慢还容易出错。我用的编曲软件Cubase也提供了键盘钢琴输入的功能，但键位很少，并不实用。很可惜javascript不可能与编曲软件通信，但我可以先在EOP类似物里面编辑好，然后再导出成midi文件，这样就可以导入到编曲软件进行后加工了。所以我又给EOP类似物加入了导入导出midi文件的功能。其实早在最先我就设计过保存文件，但是当时被定为于用于给好友发音乐片段交流用，所以我自己设计了用4096个汉字对二进制编码的base4096格式。后来由于有跟其他编曲软件互通的需求，我遗弃了这种格式转到midi文件格式。正好又发现cubase占用声卡驱动后会让其他应用无法发声，就算后台释放资源后也得重新开一遍，所以我更加倾向于在我的Eop上完成，特别是像扒谱这种工作。我陆续加入了音量、力度、bpm(速度)调节、多通道加载多音色等功能，已经能够大概播放网上下载的各种midi文件了。
![一些按钮功能分布](/img/eopplt002.png)
　　由于我本来演奏能力就很菜，加上电脑键盘更不方便，所以实时录音符的时值也是不太现实的。所以我又制作了特殊的编辑模式，可以自动等待输入音符等。然后就是一些修修补补了，如果时不时有了新想法我也会偶尔更新一下。以后如果弹得好了我再来补录一些演奏视频吧。（可能永远咕了）